name: CI Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      PROJECT_DIR: Placeholder/test1
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
      XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # REQUIRED for SonarCloud PR analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build and run tests
        working-directory: ${{ env.PROJECT_DIR }}
        run: mvn -B clean verify

      - name: Upload Jacoco coverage report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: ${{ env.PROJECT_DIR }}/target/site/jacoco/

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud Scan
        if: env.SONAR_TOKEN != ''
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=DCANascimento_TQS_Project_2 \
            -Dsonar.organization=dcanascimento \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

      - name: Authenticate with Xray
        id: xray-auth
        if: env.XRAY_CLIENT_ID != ''
        run: |
          TOKEN=$(curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" \
            https://xray.cloud.getxray.app/api/v2/authenticate | tr -d '"')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Upload test results to Xray
        if: steps.xray-auth.outputs.token != ''
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          curl -H "Content-Type: multipart/form-data" \
               -H "Authorization: Bearer ${{ steps.xray-auth.outputs.token }}" \
               -F "file=@target/surefire-reports" \
               "https://xray.cloud.getxray.app/api/v2/import/execution/junit?projectKey=YOURJIRAPROJECT"
