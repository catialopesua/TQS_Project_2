name: Performance Tests (k6)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "Type of performance test"
        required: true
        default: "stress"
        type: choice
        options:
          - smoke
          - stress
          - soak

  schedule:
    - cron: "0 2 * * *"  # nightly at 02:00

env:
  BASE_URL: http://${{ secrets.SERVER_HOST }}:80
  K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}

jobs:
  k6-performance:
    runs-on: [self-hosted]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/k6.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt update
          sudo apt install -y k6

      - name: Select test
        run: |
          if [ "${{ github.event.inputs.test_type }}" = "soak" ]; then
            k6 cloud k6/soak-test.js
          elif [ "${{ github.event.inputs.test_type }}" = "smoke" ]; then
            k6 cloud k6/smoke-test.js
          else
            k6 cloud k6/stress-test.js
          fi
